version: '3'
services:
    db:
      image: mariadb:10.2
      container_name: db
      restart: on-failure
      environment:
        MYSQL_ROOT_HOST: "%"
        MYSQL_ROOT_PASSWORD: ${CROP_DATABASE_PASSWORD}
        MYSQL_DATABASE: ${CROP_DATABASE}
        MYSQL_USER: ${CROP_DATABASE_USERNAME}
        MYSQL_PASSWORD: ${CROP_DATABASE_PASSWORD}
      volumes:
        - ./mysql-dump:/docker-entrypoint-initdb.d
        - ${PWD}/database:/var/lib/mysql
      networks:
        - internal

    rproxy:
        image: nginx:alpine
        ports:
            - 80:80
            - 443:443
        restart: always
        volumes:
          - ./nginx.conf:/etc/nginx/nginx.conf:ro
        networks:
           - web
    homepage:
        image: wordpress:5.2.2-php7.2-apache
        restart: always
        environment:
          WORDPRESS_DB_HOST: db
          WORDPRESS_DB_PASSWORD: ${CROP_DATABASE_PASSWORD}
          WORDPRESS_DB_USER: ${CROP_DATABASE_USERNAME}
          WORDPRESS_DB_NAME: ${CROP_DATABASE}
          WORDPRESS_TABLE_PREFIX: "mysite_"
        links:
          - db:mysql
        volumes:
          - ${PWD}/wp-content:/var/www/html/wp-content
        networks:
          - internal
          - web
        depends_on:
          - db

    nginx:
        image: nginx:alpine
        restart: always

    apache:
        image: httpd:alpine
        restart: always
networks:
  internal:
    external: false
  web:
    external: true
